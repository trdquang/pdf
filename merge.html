<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Merge PDF Files</title>
  <!-- Thêm Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>
</head>
<body>

  <!-- Container chính -->
  <div class="container mt-5">
    <h2 class="text-center mb-4">Ghép Nối Các Tập Tin PDF</h2>
    <!-- Form tải lên file -->
    <div class="row justify-content-center">
      <div class="col-md-6">
        <div class="mb-3">
          <label for="pdfFiles" class="form-label">Chọn các file PDF</label>
          <input class="form-control" type="file" id="pdfFiles" multiple accept=".pdf">
        </div>
        <!-- Nút ghép nối -->
        <button id="mergeBtn" class="btn btn-primary w-100">Ghép Nối PDF</button>
      </div>
    </div>
    <div class="row justify-content-center mt-4">
      <div class="col-md-6 text-center">
        <!-- Nút tải xuống -->
        <button id="downloadBtn" class="btn btn-success w-100" style="display: none;">Tải Xuống PDF Đã Ghép Nối</button>
      </div>
    </div>
  </div>

  <!-- Thêm Bootstrap và jQuery -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
  
  <script>
    document.getElementById('mergeBtn').addEventListener('click', async () => {
      const files = document.getElementById('pdfFiles').files;

      // Kiểm tra xem người dùng đã chọn file chưa
      if (files.length < 2) {
        alert("Vui lòng chọn ít nhất 2 file PDF để ghép nối.");
        return;
      }

      try {
        // Tạo một PDF mới
        const pdfDoc = await PDFLib.PDFDocument.create();
        
        for (let i = 0; i < files.length; i++) {
          const file = files[i];
          const fileBuffer = await file.arrayBuffer();
          
          // Tải từng PDF và sao chép các trang vào PDF mới
          const existingPdf = await PDFLib.PDFDocument.load(fileBuffer);
          const copiedPages = await pdfDoc.copyPages(existingPdf, existingPdf.getPageIndices());
          
          copiedPages.forEach(page => pdfDoc.addPage(page));
        }

        // Lưu lại PDF đã ghép nối
        const mergedPdfBytes = await pdfDoc.save();

        // Tạo một đối tượng Blob và liên kết tải xuống
        const blob = new Blob([mergedPdfBytes], { type: 'application/pdf' });
        const url = URL.createObjectURL(blob);
        
        // Hiển thị nút tải xuống
        const downloadBtn = document.getElementById('downloadBtn');
        downloadBtn.style.display = 'inline-block';
        
        // Tạo sự kiện click để tải xuống file PDF
        downloadBtn.addEventListener('click', () => {
          const link = document.createElement('a');
          link.href = url;
          link.download = 'merged.pdf'; // Đặt tên file khi tải xuống
          link.click();
        });
        
      } catch (error) {
        console.error("Lỗi khi ghép nối PDF:", error);
        alert("Đã có lỗi xảy ra khi ghép nối các file PDF.");
      }
    });
  </script>

  <script src="/js/merge.js"></script>
</body>
</html>
